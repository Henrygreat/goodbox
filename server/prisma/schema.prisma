generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  super_admin
  cell_leader
}

enum MaritalStatus {
  single
  married
  undisclosed
}

enum MemberStatus {
  pending_approval
  active
  inactive
}

enum FollowUpType {
  visit
  call
  message
}

enum ServiceType {
  sunday
  midweek
  cell_meeting
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum NotificationType {
  birthday
  reminder
  approval
}

enum MemberJourneyStatus {
  new
  contacted
  engaged
  foundation
  active_member
  potential_leader
}

//
// ===============================
// Rota (NEW)
// ===============================
//
enum RotaServiceType {
  sunday
  wednesday
}

enum RotaRole {
  opening_prayer
  rhapsody_reading
  closing_announcements
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  phone        String?
  role         UserRole
  createdAt    DateTime @default(now()) @map("created_at")

  // ✅ reverse side of Member.user
  member        Member?

  // Relations
  ledCellGroups        CellGroup[]          @relation("CellGroupLeader")
  assignedMembers      Member[]             @relation("AssignedLeader")
  followUps            FollowUp[]
  notifications        Notification[]
  requestedApprovals   PendingApproval[]    @relation("RequestedBy")
  reviewedApprovals    PendingApproval[]    @relation("ReviewedBy")

  // V2
  passwordResetTokens  PasswordResetToken[]
  imports              Import[]

  // Rota
  createdRotas         Rota[]               @relation("RotaCreatedBy")
  rotaAssignments      RotaAssignment[]     @relation("RotaAssignmentUser")

  @@map("users")
}

model CellGroup {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  leaderId    Int?     @map("leader_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  leader  User?    @relation("CellGroupLeader", fields: [leaderId], references: [id], onDelete: SetNull)
  members Member[]

  @@map("cell_groups")
}

model Member {
  id                        Int                 @id @default(autoincrement())
  firstName                 String              @map("first_name")
  lastName                  String              @map("last_name")
  email                     String?
  phone                     String?
  address                   String?
  birthday                  DateTime?
  maritalStatus             MaritalStatus       @default(undisclosed) @map("marital_status")
  broughtBy                 String?             @map("brought_by")
  dateJoined                DateTime            @default(now()) @map("date_joined")
  cellGroupId               Int?                @map("cell_group_id")
  assignedLeaderId          Int?                @map("assigned_leader_id")
  foundationSchoolCompleted Boolean             @default(false) @map("foundation_school_completed")
  foundationSchoolDate      DateTime?           @map("foundation_school_date")
  status                    MemberStatus        @default(pending_approval)
  journeyStatus             MemberJourneyStatus @default(new) @map("journey_status")
  notes                     String?
  createdAt                 DateTime            @default(now()) @map("created_at")
  updatedAt                 DateTime            @updatedAt @map("updated_at")

  // ✅ LINK MEMBER -> USER (optional)
  userId Int?   @unique @map("user_id")
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Relations
  cellGroup        CellGroup?        @relation(fields: [cellGroupId], references: [id], onDelete: SetNull)
  assignedLeader   User?             @relation("AssignedLeader", fields: [assignedLeaderId], references: [id], onDelete: SetNull)
  followUps        FollowUp[]
  attendance       Attendance[]
  pendingApprovals PendingApproval[]

  @@index([cellGroupId])
  @@index([assignedLeaderId])
  @@map("members")
}

model FollowUp {
  id           Int        @id @default(autoincrement())
  memberId     Int        @map("member_id")
  leaderId     Int        @map("leader_id")
  type         FollowUpType
  notes        String?
  followUpDate DateTime   @map("follow_up_date")
  createdAt    DateTime   @default(now()) @map("created_at")

  // Relations
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  leader User   @relation(fields: [leaderId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([leaderId])
  @@map("follow_ups")
}

model Attendance {
  id          Int         @id @default(autoincrement())
  memberId    Int         @map("member_id")
  serviceDate DateTime    @map("service_date")
  serviceType ServiceType @map("service_type")
  attended    Boolean     @default(true)
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, serviceDate, serviceType])
  @@index([serviceDate])
  @@map("attendance")
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int              @map("user_id")
  title     String
  message   String
  type      NotificationType
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model PendingApproval {
  id          Int            @id @default(autoincrement())
  memberId    Int            @map("member_id")
  requestedBy Int            @map("requested_by")
  status      ApprovalStatus @default(pending)
  reviewedBy  Int?           @map("reviewed_by")
  reviewedAt  DateTime?      @map("reviewed_at")
  createdAt   DateTime       @default(now()) @map("created_at")

  // Relations
  member    Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  requester User   @relation("RequestedBy", fields: [requestedBy], references: [id], onDelete: Cascade)
  reviewer  User?  @relation("ReviewedBy", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([memberId])
  @@index([requestedBy])
  @@index([reviewedBy])
  @@map("pending_approvals")
}

//
// ===============================
// V2 Models - Password Reset & Import
// ===============================
//
model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

enum ImportStatus {
  pending
  parsed
  committed
  failed
}

model Import {
  id        Int          @id @default(autoincrement())
  filename  String
  filePath  String       @map("file_path")
  fileType  String       @map("file_type")
  status    ImportStatus @default(pending)
  rowCount  Int?         @map("row_count")
  createdBy Int          @map("created_by")
  parsedData Json?       @map("parsed_data")
  errors    Json?
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  // Relations
  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([status])
  @@map("imports")
}

//
// ===============================
// Rota Models (NEW)
// ===============================
//
model Rota {
  id          Int             @id @default(autoincrement())
  serviceDate DateTime        @map("service_date")
  serviceType RotaServiceType @map("service_type")
  notes       String?
  createdById Int             @map("created_by_id")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  createdBy   User            @relation("RotaCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  assignments RotaAssignment[]

  @@unique([serviceDate, serviceType])
  @@index([serviceDate])
  @@index([serviceType])
  @@map("rota")
}

model RotaAssignment {
  id     Int      @id @default(autoincrement())
  rotaId Int      @map("rota_id")
  role   RotaRole
  userId Int?     @map("user_id")
  name   String?

  rota Rota  @relation(fields: [rotaId], references: [id], onDelete: Cascade)
  user User? @relation("RotaAssignmentUser", fields: [userId], references: [id], onDelete: SetNull)

  @@unique([rotaId, role])
  @@index([rotaId])
  @@index([userId])
  @@map("rota_assignments")
}